# Copyright (c) 2023 Bela Schaum, X-Ryl669, Denis Mikhailov.
#
# Distributed under the Boost Software License, Version 1.0. (See accompanying
# file LICENSE_1_0.txt or copy at http://www.boost.org/LICENSE_1_0.txt)


# Initial implementation by Bela Schaum, https://github.com/schaumb
# The way to make it union and UB free by X-Ryl669, https://github.com/X-Ryl669
#

import python ;
import testing ;
import ../../config/checks/config : requires ;

########## BEGIN of helpers to detect C++20 features support

actions mp_simple_run_action
{
      $(>) > $(<)
}

rule mp-run-simple ( sources + : args * : input-files * : requirements * : target-name )
{
   exe $(target-name)_exe : $(sources) : $(requirements) ;
   explicit $(target-name)_exe ;
   make $(target-name).output : $(target-name)_exe : @mp_simple_run_action ;
   explicit $(target-name).output ;
   alias $(target-name) : $(target-name).output ;
}

mp-run-simple cxx20_address_of_non_static_member_tplarg_detection.cpp : : : : compiler_supports_cxx20_address_of_non_static_member_tplarg ;
explicit compiler_supports_cxx20_address_of_non_static_member_tplarg ;

mp-run-simple cxx20_nontype_tplarg_detection.cpp : : : : compiler_supports_cxx20_nontype_tplarg ;
explicit compiler_supports_cxx20_nontype_tplarg ;

########## END of helpers to detect C++20 features support

project
    : source-location .
    : requirements
        <define>BOOST_PFR_DETAIL_STRICT_RVALUE_TESTING=1
        [ check-target-builds ../core_name//compiler_supports_cxx20_address_of_non_static_member_tplarg : : [ check-target-builds ../core_name//compiler_supports_cxx20_nontype_tplarg : : <build>no ] ]
    ;

local ENABLED_ENGINE = <define>BOOST_PFR_ENABLE_GET_NAME_STATIC=1 ;
local DISABLED_ENGINE = <define>BOOST_PFR_ENABLE_GET_NAME_STATIC=0 ;



actions invoke_python_generator
{
        python $(>) > $(<)
}

make fields_names_nonascii.cpp : generate_fields_names_nonascii.cpp.py : @invoke_python_generator ;
make fields_names_big.cpp : generate_fields_names_big.cpp.py : @invoke_python_generator ;

test-suite pfr_name_tests
  :
    [ run fields_names.cpp : : : : ]
    [ run fields_names_constexpr.cpp : : : : ]
    [ run fields_names_nonascii.cpp : : : <toolset>msvc:<cxxflags>"/utf-8" : ]
    [ run fields_names_big.cpp : : : <toolset>msvc:<cxxflags>"/bigobj" : ]
    [ run fields_names_correctly_configured_compiler.cpp : : : : ]
    [ run fields_names_internal_parser.cpp : : : : ]
    [ run print_name.cpp : : : <test-info>always_show_run_output ]
  ;

for local source_file in [ glob ./compile-fail/*.cpp ]
{
    local target_name = $(source_file[1]:B) ;
    pfr_name_tests += [ compile-fail $(source_file) : $(ENABLED_ENGINE) : $(target_name)_on ] ;
    pfr_name_tests += [ compile-fail $(source_file) : $(DISABLED_ENGINE) : $(target_name)_off ] ;
}


